<!DOCTYPE html>
<html>

<head>
    <title>Browser test</title>
    <!-- reading SDK in a script tag... -->
    <script type="text/javascript" src="./lib/browser.js"></script>
</head>

<body>
    <div id="signedIn" style="display:none;">
        <div class="apis">
            <ul>
                <li>
                    <a href="javascript:void(0);" onclick="refreshToken();">silent signIn</a>
                </li>
                <li>
                    <a href="javascript:void(0);" onclick="signOut();">signOut</a>
                </li>
                <li>
                    <a href="javascript:void(0);" onclick="searchCoinAccounts();">コイン口座検索</a>
                </li>
                <li>
                    <a href="javascript:void(0);" onclick="startWithdrawCoinTransaction();">コイン出金取引開始</a>
                </li>
            </ul>
        </div>
        <div>
            profile:
            <br>
            <textarea id="profile" readonly rows="20" cols="80"></textarea>
        </div>
    </div>

    <div id="signedOut" style="display:none;">
        <a href="javascript:void(0);" onclick="signIn();">signIn</a>
        <br>
    </div>

    <p>
        results:
        <br>
        <textarea id="results" readonly rows="20" cols="80"></textarea>
    </p>
    <p>
        idToken:
        <br>
        <textarea id="idToken" readonly rows="20" cols="80"></textarea>
    </p>
    <p>
        accessToken:
        <br>
        <textarea id="accessToken" readonly rows="20" cols="80"></textarea>
    </p>

    <script>
        // AWS Defining Resource Servers for Your User Pool
        // http://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/cognito-user-pools-define-resource-servers.html
        // https://aws.amazon.com/blogs/mobile/integrating-amazon-cognito-user-pools-with-api-gateway/

        var DOMAIN = 'xxxxx';
        var CLIENT_ID = 'xxxxx'; // given by a token provider
        var CALLBACK_URL = 'http://localhost:8080/signIn.html'; // an application should prepare it
        var LOGOUT_URL = 'http://localhost:8080/signOut.html'; // an application should prepare it
        var ISSUER = 'xxxxx';
        var API_ENDPOINT = 'xxxxx';
        var RESOURCE_SERVER_IDENFIER = 'xxxxx';
        var APIM_SUBSCRIPTION_KEY = 'xxxxx';

        var credentials = null;

        var scopes = [];

        var options = {
            domain: DOMAIN,
            clientId: CLIENT_ID,
            responseType: 'token',
            redirectUri: CALLBACK_URL,
            logoutUri: LOGOUT_URL,
            scope: scopes.join(' '),
            state: '12345',
            nonce: randomString(16),
            tokenIssuer: ISSUER
        };
        const auth = mocoin.createAuthInstance(options);

        // check if already signed in
        // result is credentials
        auth.isSignedIn().then(function (result) {
            if (result === null) {
                onSignOut();
            } else {
                credentials = result;
                onSignIn();
            }
        });

        function randomString(length) {
            var bytes = new Uint8Array(length);
            var random = window.crypto.getRandomValues(bytes);
            var result = [];
            var charset = '0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz-._~'
            random.forEach(function (c) {
                result.push(charset[c % charset.length]);
            });
            return result.join('');
        }

        function onSignIn() {
            toggleUserDisplay(true);
            setTimeout(displayProfile, 100);
        }

        function onSignOut() {
            toggleUserDisplay(false);
            initTextarea();
        }

        function format(value) {
            return JSON.stringify(value, null, 4);
        }

        function toggleUserDisplay(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('signedIn').style.display = 'block';
                document.getElementById('signedOut').style.display = 'none';
            } else {
                document.getElementById('signedIn').style.display = 'none';
                document.getElementById('signedOut').style.display = 'block';
            }
        }

        function displayProfile() {
            document.getElementById('profile').innerText = format(credentials.idTokenPayload);
        }

        function initTextarea() {
            Array.from(document.getElementsByTagName('textarea'), function (element) {
                element.innerText = '';
            });
        }

        function signIn() {
            // signIn
            // result is credentials
            auth.signIn().then(function (result) {
                console.log('signIn result:', result);
                document.getElementById('idToken').innerText = result.idToken;
                document.getElementById('accessToken').innerText = result.accessToken;

                credentials = result;
                onSignIn();
            }).catch(function (err) {
                console.error(err);
            });
        }

        function refreshToken() {
            // refreshToken in iframe
            // result is credentials
            auth.refreshToken().then(function (result) {
                console.log('tryRenewAuth result:', result);
                document.getElementById('idToken').innerText = result.idToken;
                document.getElementById('accessToken').innerText = result.accessToken;
            }).catch(function (err) {
                console.error(err);
            });
        }

        function signOut() {
            auth.signOut().then(function () {
                credentials = null;
                onSignOut();
            }).catch(function (err) {
                console.error(err);
            });
        }

        function searchCoinAccounts() {
            var personService = new mocoin.service.Person({
                endpoint: API_ENDPOINT,
                auth: auth
            });
            personService.searchCoinAccounts(
                {
                    personId: 'me'
                },
                {
                    headers: {
                        'Ocp-Apim-Subscription-Key': APIM_SUBSCRIPTION_KEY
                    }
                }
            ).then(function (accounts) {
                console.log('accounts:', accounts);
                document.getElementById('results').innerText = format(accounts);
            }).catch(function (err) {
                console.error(err);
                document.getElementById('results').innerText = format(err);
            });
        }

        function startWithdrawCoinTransaction() {
            var withdrawCoinervice = new mocoin.service.transaction.WithdrawCoin({
                endpoint: API_ENDPOINT,
                auth: auth
            });
            withdrawCoinervice.start(
                {
                    expires: new Date(),
                    agent: {
                        typeOf: mocoin.factory.personType.Person,
                        name: 'name'
                    },
                    recipient: {
                        typeOf: mocoin.factory.personType.Person,
                        name: 'name'
                    },
                    amount: 1,
                    notes: 'test from sample',
                    fromLocation: {
                        typeOf: mocoin.factory.ownershipInfo.AccountGoodType.CoinAccount,
                        accountNumber: '####'
                    }
                },
                {
                    headers: {
                        'Ocp-Apim-Subscription-Key': APIM_SUBSCRIPTION_KEY
                    }
                }
            ).then(function (transaction) {
                console.log('transaction:', transaction);
                document.getElementById('results').innerText = format(transaction);
            }).catch(function (err) {
                console.error(err);
                document.getElementById('results').innerText = format(err);
            });
        }
    </script>

</body>

</html>